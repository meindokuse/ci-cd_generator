stages:
  - build
  - test
  - lint
  - sonarqube
  - security
  - integration
  - deploy

variables:
  DOCKER_IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
  DOCKER_IMAGE_LATEST: "$CI_REGISTRY_IMAGE:latest"
  SSH_PORT: "22"
  DEPLOY_ENV: "production"
  SONAR_HOST_URL: "http://sonarqube:9000"

# ========== BUILD STAGE ==========
build:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "üîê Logging into Docker Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è  Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE:latest .
    - echo "üì§ Pushing to Docker Registry..."
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "‚úÖ Docker image stored in registry"
  only:
    - main
  tags:
    - docker
  retry:
    max: 2


# ========== TEST STAGE ==========
test:
  stage: test
  image: 

  script:
    - pytest
  
  after_script:
    
    - rm -rf test-reports || true
    
    - rm -rf coverage || true
    
    - echo 'Generic test cleanup done'
    
  
  tags:
    - docker
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  artifacts:
    paths:
      
      
      - test-reports/
      
      - coverage/
      
      
    expire_in: 1 week

# ========== LINT STAGE ==========
lint:
  stage: lint
  image: golang:1.24.0-alpine
  script:
    - apk add --no-cache git
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
    - echo "Running: golangci-lint"
    - $GOPATH/bin/golangci-lint run ./... || true
  allow_failure: true
  only:
    - main
    - merge_requests
  tags:
    - docker

# ========== SONARQUBE STAGE ==========
sonarqube:
  stage: sonarqube
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"  # Shallow clone disabled for better analysis
  script:
    - echo "üîç Running SonarQube analysis..."
    - sonar-scanner
      -Dsonar.projectKey=$CI_PROJECT_NAME
      -Dsonar.sources=.
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.sources=.
      -Dsonar.exclusions=**/*_test.go,**/vendor/**
      -Dsonar.go.coverage.reportPaths=coverage.out
  allow_failure: true
  only:
    - main
    - merge_requests
  tags:
    - docker
  cache:
    key: "${CI_COMMIT_REF_SLUG}-sonar"
    paths:
      - .sonar/cache

# ========== SECURITY STAGE ==========
security:
  stage: security
  image: golang:1.24.0-alpine
  script:
    - go install github.com/securego/gosec/v2/cmd/gosec@latest
    - echo "Running: gosec"
    - $GOPATH/bin/gosec ./... || true
  allow_failure: true
  only:
    - main
    - merge_requests
  tags:
    - docker
security_docker:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "üîí Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --no-progress $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA || true
    - echo "‚úÖ Docker security scan complete!"
  allow_failure: true
  only:
    - main
  tags:
    - docker


